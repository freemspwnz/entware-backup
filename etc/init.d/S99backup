#!/opt/bin/sh
#
# SysVinit script for Entware: run backup on schedule or manually.
# Install to /opt/etc/init.d/S99backup.
# Process PID: /opt/var/run/backup.pid

BACKUP_PID_FILE="/opt/var/run/backup.pid"
BACKUP_SCRIPT="/opt/usr/local/bin/backup.sh"

start() {
    if [ -f "$BACKUP_PID_FILE" ]; then
        pid="$(cat "$BACKUP_PID_FILE")"
        if kill -0 "$pid" 2>/dev/null; then
            echo "Backup already running (PID $pid)."
            return 1
        fi
        rm -f "$BACKUP_PID_FILE"
    fi

    mkdir -p "$(dirname "$BACKUP_PID_FILE")"
    (
        export BACKUP_CONF_PATH="${BACKUP_CONF_PATH:-/opt/usr/local/etc/backup/backup.conf}"
        export BACKUP_SECRETS_PATH="${BACKUP_SECRETS_PATH:-/opt/usr/local/secrets/.backup.env}"
        "$BACKUP_SCRIPT"
    ) &
    echo $! > "$BACKUP_PID_FILE"
    echo "Backup started (PID $(cat "$BACKUP_PID_FILE"))."
}

stop() {
    if [ ! -f "$BACKUP_PID_FILE" ]; then
        echo "Backup is not running (no PID file)."
        return 0
    fi
    pid="$(cat "$BACKUP_PID_FILE")"
    if kill -0 "$pid" 2>/dev/null; then
        kill "$pid" 2>/dev/null || true
        echo "Backup stopped (PID $pid)."
    else
        echo "Backup was not running (stale PID $pid)."
    fi
    rm -f "$BACKUP_PID_FILE"
}

status() {
    if [ ! -f "$BACKUP_PID_FILE" ]; then
        echo "Backup is not running."
        return 1
    fi
    pid="$(cat "$BACKUP_PID_FILE")"
    if kill -0 "$pid" 2>/dev/null; then
        echo "Backup is running (PID $pid)."
        return 0
    else
        echo "Backup is not running (stale PID file: $pid)."
        rm -f "$BACKUP_PID_FILE"
        return 1
    fi
}

case "${1:-}" in
    start)   start ;;
    stop)    stop ;;
    restart) stop; start ;;
    status)  status ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
